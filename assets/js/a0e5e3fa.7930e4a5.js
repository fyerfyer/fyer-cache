"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[21],{2521:(r,e,n)=>{n.r(e),n.d(e,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"distribute-caching/data-consistency","title":"Cache Consistency Strategy","description":"FyerCache \u63d0\u4f9b\u591a\u79cd\u7f13\u5b58\u4e00\u81f4\u6027\u7b56\u7565\uff0c\u6bcf\u79cd\u7b56\u7565\u9002\u7528\u4e8e\u4e0d\u540c\u7684\u573a\u666f\u548c\u8981\u6c42\u3002","source":"@site/docs/distribute-caching/data-consistency.md","sourceDirName":"distribute-caching","slug":"/distribute-caching/data-consistency","permalink":"/fyer-cache/docs/distribute-caching/data-consistency","draft":false,"unlisted":false,"editUrl":"https://github.com/fyerfyer/fyer-rpc/tree/main/docs/distribute-caching/data-consistency.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Sharding Principles","permalink":"/fyer-cache/docs/core-concepts/sharding"},"next":{"title":"Distributed Caching Overview","permalink":"/fyer-cache/docs/distribute-caching/distribution-cache"}}');var i=n(4848),c=n(8453);const a={},s="Cache Consistency Strategy",o={},l=[{value:"\u6838\u5fc3\u63a5\u53e3\u8bbe\u8ba1",id:"\u6838\u5fc3\u63a5\u53e3\u8bbe\u8ba1",level:2},{value:"ConsistencyStrategy \u63a5\u53e3",id:"consistencystrategy-\u63a5\u53e3",level:3},{value:"DataSource \u63a5\u53e3",id:"datasource-\u63a5\u53e3",level:3},{value:"Cache-Aside \u7b56\u7565",id:"cache-aside-\u7b56\u7565",level:2},{value:"\u5b9e\u73b0\u7ec6\u8282",id:"\u5b9e\u73b0\u7ec6\u8282",level:3},{value:"Get \u64cd\u4f5c\u6d41\u7a0b",id:"get-\u64cd\u4f5c\u6d41\u7a0b",level:4},{value:"Set \u64cd\u4f5c\u6d41\u7a0b",id:"set-\u64cd\u4f5c\u6d41\u7a0b",level:4},{value:"Del \u64cd\u4f5c\u6d41\u7a0b",id:"del-\u64cd\u4f5c\u6d41\u7a0b",level:4},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b",level:3},{value:"\u914d\u7f6e\u9009\u9879",id:"\u914d\u7f6e\u9009\u9879",level:3},{value:"Write-Through \u7b56\u7565",id:"write-through-\u7b56\u7565",level:2},{value:"\u5b9e\u73b0\u7ec6\u8282",id:"\u5b9e\u73b0\u7ec6\u8282-1",level:3},{value:"Set \u64cd\u4f5c\u4e0e\u5ef6\u8fdf\u5199\u5165",id:"set-\u64cd\u4f5c\u4e0e\u5ef6\u8fdf\u5199\u5165",level:4},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b-1",level:3},{value:"\u914d\u7f6e\u9009\u9879",id:"\u914d\u7f6e\u9009\u9879-1",level:3},{value:"\u57fa\u4e8e\u6d88\u606f\u961f\u5217\u7684\u901a\u77e5\u7b56\u7565",id:"\u57fa\u4e8e\u6d88\u606f\u961f\u5217\u7684\u901a\u77e5\u7b56\u7565",level:2},{value:"\u5b9e\u73b0\u7ec6\u8282",id:"\u5b9e\u73b0\u7ec6\u8282-2",level:3},{value:"\u53d1\u5e03\u7f13\u5b58\u66f4\u65b0\u6d88\u606f",id:"\u53d1\u5e03\u7f13\u5b58\u66f4\u65b0\u6d88\u606f",level:4},{value:"\u5904\u7406\u63a5\u6536\u5230\u7684\u6d88\u606f",id:"\u5904\u7406\u63a5\u6536\u5230\u7684\u6d88\u606f",level:4},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b-2",level:3},{value:"\u914d\u7f6e\u9009\u9879",id:"\u914d\u7f6e\u9009\u9879-2",level:3}];function h(r){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...r.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"cache-consistency-strategy",children:"Cache Consistency Strategy"})}),"\n",(0,i.jsx)(e.p,{children:"FyerCache \u63d0\u4f9b\u591a\u79cd\u7f13\u5b58\u4e00\u81f4\u6027\u7b56\u7565\uff0c\u6bcf\u79cd\u7b56\u7565\u9002\u7528\u4e8e\u4e0d\u540c\u7684\u573a\u666f\u548c\u8981\u6c42\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u6838\u5fc3\u63a5\u53e3\u8bbe\u8ba1",children:"\u6838\u5fc3\u63a5\u53e3\u8bbe\u8ba1"}),"\n",(0,i.jsx)(e.h3,{id:"consistencystrategy-\u63a5\u53e3",children:"ConsistencyStrategy \u63a5\u53e3"}),"\n",(0,i.jsxs)(e.p,{children:["\u6240\u6709\u4e00\u81f4\u6027\u7b56\u7565\u90fd\u5b9e\u73b0\u4e86 ",(0,i.jsx)(e.code,{children:"ConsistencyStrategy"})," \u63a5\u53e3\uff1a"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// ConsistencyStrategy \u5b9a\u4e49\u7f13\u5b58\u4e00\u81f4\u6027\u7b56\u7565\u63a5\u53e3\r\ntype ConsistencyStrategy interface {\r\n    // Get \u4ece\u7f13\u5b58\u83b7\u53d6\u6570\u636e\uff0c\u7f13\u5b58\u4e0d\u5b58\u5728\u65f6\u4ece\u6570\u636e\u6e90\u83b7\u53d6\r\n    Get(ctx context.Context, key string) (any, error)\r\n\r\n    // Set \u8bbe\u7f6e\u7f13\u5b58\u6570\u636e\u5e76\u6839\u636e\u7b56\u7565\u540c\u6b65\u5230\u6570\u636e\u6e90\r\n    Set(ctx context.Context, key string, value any, expiration time.Duration) error\r\n\r\n    // Del \u5220\u9664\u7f13\u5b58\u548c\u6570\u636e\u6e90\u4e2d\u7684\u6570\u636e\r\n    Del(ctx context.Context, key string) error\r\n\r\n    // Invalidate \u4f7f\u7f13\u5b58\u5931\u6548\u4f46\u4e0d\u5f71\u54cd\u6570\u636e\u6e90\r\n    Invalidate(ctx context.Context, key string) error\r\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"datasource-\u63a5\u53e3",children:"DataSource \u63a5\u53e3"}),"\n",(0,i.jsxs)(e.p,{children:["\u4e00\u81f4\u6027\u7b56\u7565\u9700\u8981\u4e0e\u540e\u7aef\u6570\u636e\u6e90\u4ea4\u4e92\uff0c\u8fd9\u7531 ",(0,i.jsx)(e.code,{children:"DataSource"})," \u63a5\u53e3\u5b9a\u4e49\uff1a"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// DataSource \u5b9a\u4e49\u6570\u636e\u6e90\u63a5\u53e3\r\ntype DataSource interface {\r\n    // Load \u4ece\u6570\u636e\u6e90\u52a0\u8f7d\u6570\u636e\r\n    Load(ctx context.Context, key string) (any, error)\r\n\r\n    // Store \u5c06\u6570\u636e\u4fdd\u5b58\u5230\u6570\u636e\u6e90\r\n    Store(ctx context.Context, key string, value any) error\r\n\r\n    // Remove \u4ece\u6570\u636e\u6e90\u5220\u9664\u6570\u636e\r\n    Remove(ctx context.Context, key string) error\r\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"cache-aside-\u7b56\u7565",children:"Cache-Aside \u7b56\u7565"}),"\n",(0,i.jsx)(e.p,{children:"Cache-Aside\uff08\u65c1\u8def\u7f13\u5b58\uff09\u662f\u6700\u5e38\u7528\u7684\u7f13\u5b58\u7b56\u7565\u4e4b\u4e00\uff0c\u5176\u5de5\u4f5c\u539f\u7406\u662f\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u8bfb\u53d6\u65f6\u5148\u67e5\u7f13\u5b58\uff0c\u7f13\u5b58\u672a\u547d\u4e2d\u5219\u4ece\u6570\u636e\u6e90\u52a0\u8f7d\u5e76\u5199\u5165\u7f13\u5b58"}),"\n",(0,i.jsx)(e.li,{children:"\u5199\u5165\u65f6\u5148\u66f4\u65b0\u6570\u636e\u6e90\uff0c\u518d\u66f4\u65b0\u7f13\u5b58"}),"\n",(0,i.jsx)(e.li,{children:"\u5220\u9664\u65f6\u5148\u5220\u9664\u7f13\u5b58\uff0c\u518d\u5220\u9664\u6570\u636e\u6e90"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"\u5b9e\u73b0\u7ec6\u8282",children:"\u5b9e\u73b0\u7ec6\u8282"}),"\n",(0,i.jsx)(e.p,{children:"FyerCache \u4e2d\u7684 Cache-Aside \u7b56\u7565\u5b9e\u73b0\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// NewCacheAsideStrategy \u521b\u5efaCache Aside\u7b56\u7565\u5b9e\u4f8b\r\nfunc NewCacheAsideStrategy(cache cache.Cache, dataSource DataSource, opts ...Option) *CacheAsideStrategy {\r\n    options := defaultCacheAsideOptions()\r\n\r\n    // \u5e94\u7528\u9009\u9879\r\n    for _, opt := range opts {\r\n        opt(options)\r\n    }\r\n\r\n    return &CacheAsideStrategy{\r\n        cache:      cache,\r\n        dataSource: dataSource,\r\n        options:    options,\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(e.h4,{id:"get-\u64cd\u4f5c\u6d41\u7a0b",children:"Get \u64cd\u4f5c\u6d41\u7a0b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// Get \u4ece\u7f13\u5b58\u83b7\u53d6\u6570\u636e\uff0c\u7f13\u5b58\u672a\u547d\u4e2d\u65f6\u4ece\u6570\u636e\u6e90\u83b7\u53d6\r\nfunc (c *CacheAsideStrategy) Get(ctx context.Context, key string) (any, error) {\r\n    // \u9996\u5148\u5c1d\u8bd5\u4ece\u7f13\u5b58\u83b7\u53d6\r\n    value, err := c.cache.Get(ctx, key)\r\n    if err == nil {\r\n        // \u7f13\u5b58\u547d\u4e2d\uff0c\u76f4\u63a5\u8fd4\u56de\r\n        return value, nil\r\n    }\r\n\r\n    // \u5982\u679c\u9519\u8bef\u4e0d\u662f"\u952e\u4e0d\u5b58\u5728"\uff0c\u5219\u8fd4\u56de\u9519\u8bef\r\n    if err != ferr.ErrKeyNotFound {\r\n        return nil, err\r\n    }\r\n\r\n    // \u4ece\u6570\u636e\u6e90\u83b7\u53d6\r\n    value, err = c.dataSource.Load(ctx, key)\r\n    if err != nil {\r\n        return nil, fmt.Errorf("failed to load from data source: %w", err)\r\n    }\r\n\r\n    // \u5982\u679c\u914d\u7f6e\u4e86\u7f13\u5b58\u672a\u547d\u4e2d\u65f6\u5199\u5165\uff0c\u5c06\u6570\u636e\u5199\u5165\u7f13\u5b58\r\n    if c.options.WriteOnMiss {\r\n        // \u4f7f\u7528\u9ed8\u8ba4\u8fc7\u671f\u65f6\u95f4\u5199\u5165\u7f13\u5b58\r\n        // \u8fd9\u91cc\u4e0d\u5904\u7406\u5199\u5165\u7f13\u5b58\u7684\u9519\u8bef\uff0c\u5373\u4f7f\u5199\u5165\u5931\u8d25\u4e5f\u8fd4\u56de\u67e5\u8be2\u7ed3\u679c\r\n        _ = c.cache.Set(ctx, key, value, c.options.DefaultTTL)\r\n    }\r\n\r\n    return value, nil\r\n}\n'})}),"\n",(0,i.jsx)(e.h4,{id:"set-\u64cd\u4f5c\u6d41\u7a0b",children:"Set \u64cd\u4f5c\u6d41\u7a0b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// Set \u8bbe\u7f6e\u7f13\u5b58\u6570\u636e\u5e76\u540c\u6b65\u5230\u6570\u636e\u6e90\r\n// \u5728Cache Aside\u6a21\u5f0f\u4e2d\uff0c\u5148\u66f4\u65b0\u6570\u636e\u6e90\u518d\u66f4\u65b0\u7f13\u5b58\r\nfunc (c *CacheAsideStrategy) Set(ctx context.Context, key string, value any, expiration time.Duration) error {\r\n    // \u5148\u66f4\u65b0\u6570\u636e\u6e90\r\n    if err := c.dataSource.Store(ctx, key, value); err != nil {\r\n        return fmt.Errorf("failed to store in data source: %w", err)\r\n    }\r\n\r\n    // \u518d\u66f4\u65b0\u7f13\u5b58\r\n    if err := c.cache.Set(ctx, key, value, expiration); err != nil {\r\n        // \u5373\u4f7f\u7f13\u5b58\u66f4\u65b0\u5931\u8d25\uff0c\u6570\u636e\u6e90\u5df2\u66f4\u65b0\u6210\u529f\uff0c\u6211\u4eec\u4ecd\u8ba4\u4e3a\u64cd\u4f5c\u6210\u529f\r\n        // \u4f46\u8bb0\u5f55\u9519\u8bef\r\n        return fmt.Errorf("data source updated but cache set failed: %w", err)\r\n    }\r\n\r\n    return nil\r\n}\n'})}),"\n",(0,i.jsx)(e.h4,{id:"del-\u64cd\u4f5c\u6d41\u7a0b",children:"Del \u64cd\u4f5c\u6d41\u7a0b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// Del \u5220\u9664\u7f13\u5b58\u548c\u6570\u636e\u6e90\u4e2d\u7684\u6570\u636e\r\n// \u5728Cache Aside\u6a21\u5f0f\u4e2d\uff0c\u5148\u5220\u9664\u7f13\u5b58\u518d\u5220\u9664\u6570\u636e\u6e90\r\nfunc (c *CacheAsideStrategy) Del(ctx context.Context, key string) error {\r\n    // \u5148\u5220\u9664\u7f13\u5b58\r\n    _ = c.cache.Del(ctx, key)\r\n\r\n    // \u518d\u5220\u9664\u6570\u636e\u6e90\r\n    if err := c.dataSource.Remove(ctx, key); err != nil {\r\n        return fmt.Errorf("failed to remove from data source: %w", err)\r\n    }\r\n\r\n    return nil\r\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u4f7f\u7528\u793a\u4f8b",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n    "context"\r\n    "fmt"\r\n    "time"\r\n    \r\n    "github.com/fyerfyer/fyer-cache/cache"\r\n    "github.com/fyerfyer/fyer-cache/cache/consistency"\r\n)\r\n\r\n// \u7b80\u5355\u7684\u6570\u636e\u6e90\u5b9e\u73b0\r\ntype UserDB struct {\r\n    users map[string]string\r\n}\r\n\r\nfunc (db *UserDB) Load(ctx context.Context, key string) (any, error) {\r\n    if val, exists := db.users[key]; exists {\r\n        return val, nil\r\n    }\r\n    return nil, fmt.Errorf("user not found")\r\n}\r\n\r\nfunc (db *UserDB) Store(ctx context.Context, key string, value any) error {\r\n    if str, ok := value.(string); ok {\r\n        db.users[key] = str\r\n        return nil\r\n    }\r\n    return fmt.Errorf("invalid value type")\r\n}\r\n\r\nfunc (db *UserDB) Remove(ctx context.Context, key string) error {\r\n    delete(db.users, key)\r\n    return nil\r\n}\r\n\r\nfunc main() {\r\n    // \u521d\u59cb\u5316\u7f13\u5b58\u548c\u6570\u636e\u6e90\r\n    memCache := cache.NewMemoryCache()\r\n    userDB := &UserDB{users: map[string]string{\r\n        "user:1001": "John Doe",\r\n        "user:1002": "Jane Smith",\r\n    }}\r\n    \r\n    // \u521b\u5efa Cache-Aside \u7b56\u7565\r\n    cacheStrategy := consistency.NewCacheAsideStrategy(\r\n        memCache, \r\n        userDB,\r\n        consistency.WithCacheAsideTTL(10*time.Minute),\r\n    )\r\n    \r\n    ctx := context.Background()\r\n    \r\n    // \u4f7f\u7528\u7b56\u7565\u83b7\u53d6\u6570\u636e\uff0c\u5982\u679c\u7f13\u5b58\u672a\u547d\u4e2d\uff0c\u4f1a\u4ece\u6570\u636e\u6e90\u52a0\u8f7d\r\n    value, err := cacheStrategy.Get(ctx, "user:1001")\r\n    if err != nil {\r\n        fmt.Printf("Error: %v\\n", err)\r\n        return\r\n    }\r\n    fmt.Printf("User: %v\\n", value)\r\n    \r\n    // \u5199\u5165\u6570\u636e\uff0c\u4f1a\u540c\u65f6\u66f4\u65b0\u6570\u636e\u6e90\u548c\u7f13\u5b58\r\n    err = cacheStrategy.Set(ctx, "user:1003", "Robert Brown", 10*time.Minute)\r\n    if err != nil {\r\n        fmt.Printf("Error: %v\\n", err)\r\n        return\r\n    }\r\n    \r\n    // \u5220\u9664\u6570\u636e\uff0c\u4f1a\u540c\u65f6\u4ece\u6570\u636e\u6e90\u548c\u7f13\u5b58\u4e2d\u5220\u9664\r\n    err = cacheStrategy.Del(ctx, "user:1002")\r\n    if err != nil {\r\n        fmt.Printf("Error: %v\\n", err)\r\n        return\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u914d\u7f6e\u9009\u9879",children:"\u914d\u7f6e\u9009\u9879"}),"\n",(0,i.jsx)(e.p,{children:"Cache-Aside \u7b56\u7565\u652f\u6301\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// WithCacheAsideTTL \u8bbe\u7f6e Cache Aside \u7b56\u7565\u7684\u9ed8\u8ba4TTL\r\nfunc WithCacheAsideTTL(ttl time.Duration) Option {\r\n    return func(o interface{}) {\r\n        if ca, ok := o.(*CacheAsideOptions); ok {\r\n            ca.DefaultTTL = ttl\r\n        }\r\n    }\r\n}\r\n\r\n// WithCacheAsideWriteOnMiss \u8bbe\u7f6e\u662f\u5426\u5728\u672a\u547d\u4e2d\u65f6\u5199\u5165\u7f13\u5b58\r\nfunc WithCacheAsideWriteOnMiss(writeOnMiss bool) Option {\r\n    return func(o interface{}) {\r\n        if ca, ok := o.(*CacheAsideOptions); ok {\r\n            ca.WriteOnMiss = writeOnMiss\r\n        }\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"write-through-\u7b56\u7565",children:"Write-Through \u7b56\u7565"}),"\n",(0,i.jsx)(e.p,{children:"Write-Through\uff08\u76f4\u5199\uff09\u7b56\u7565\u786e\u4fdd\u6570\u636e\u5728\u5199\u5165\u7f13\u5b58\u7684\u540c\u65f6\u4e5f\u5199\u5165\u6570\u636e\u6e90\uff0c\u4ece\u800c\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u8bfb\u53d6\u65f6\u5148\u67e5\u7f13\u5b58\uff0c\u7f13\u5b58\u672a\u547d\u4e2d\u5219\u4ece\u6570\u636e\u6e90\u52a0\u8f7d\u5e76\u5199\u5165\u7f13\u5b58"}),"\n",(0,i.jsx)(e.li,{children:"\u5199\u5165\u65f6\u5148\u66f4\u65b0\u6570\u636e\u6e90\uff0c\u518d\u66f4\u65b0\u7f13\u5b58"}),"\n",(0,i.jsx)(e.li,{children:"\u5220\u9664\u65f6\u5148\u5220\u9664\u6570\u636e\u6e90\uff0c\u518d\u5220\u9664\u7f13\u5b58"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"\u5b9e\u73b0\u7ec6\u8282-1",children:"\u5b9e\u73b0\u7ec6\u8282"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// NewWriteThroughStrategy \u521b\u5efa Write Through \u7b56\u7565\u5b9e\u4f8b\r\nfunc NewWriteThroughStrategy(cache cache.Cache, dataSource DataSource, opts ...Option) *WriteThroughStrategy {\r\n    options := defaultWriteThroughOptions()\r\n\r\n    // \u5e94\u7528\u9009\u9879\r\n    for _, opt := range opts {\r\n        opt(options)\r\n    }\r\n\r\n    return &WriteThroughStrategy{\r\n        cache:      cache,\r\n        dataSource: dataSource,\r\n        options:    options,\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(e.h4,{id:"set-\u64cd\u4f5c\u4e0e\u5ef6\u8fdf\u5199\u5165",children:"Set \u64cd\u4f5c\u4e0e\u5ef6\u8fdf\u5199\u5165"}),"\n",(0,i.jsx)(e.p,{children:"Write-Through \u7b56\u7565\u7684\u7279\u8272\u662f\u652f\u6301\u5ef6\u8fdf\u5199\u5165\uff0c\u53ef\u4ee5\u63d0\u9ad8\u5199\u5165\u6027\u80fd\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// Set \u8bbe\u7f6e\u7f13\u5b58\u6570\u636e\u5e76\u540c\u6b65\u5230\u6570\u636e\u6e90\r\n// \u5728Write Through\u6a21\u5f0f\u4e2d\uff0c\u540c\u65f6\u66f4\u65b0\u6570\u636e\u6e90\u548c\u7f13\u5b58\r\nfunc (w *WriteThroughStrategy) Set(ctx context.Context, key string, value any, expiration time.Duration) error {\r\n    // \u5982\u679c\u542f\u7528\u4e86\u5ef6\u8fdf\u5199\u5165\r\n    if w.options.DelayedWrite {\r\n        // \u5148\u66f4\u65b0\u7f13\u5b58\r\n        if err := w.cache.Set(ctx, key, value, expiration); err != nil {\r\n            return fmt.Errorf("failed to set cache: %w", err)\r\n        }\r\n\r\n        // \u5f02\u6b65\u66f4\u65b0\u6570\u636e\u6e90\r\n        go func() {\r\n            // \u521b\u5efa\u65b0\u7684\u4e0a\u4e0b\u6587\uff0c\u907f\u514d\u4f7f\u7528\u53ef\u80fd\u5df2\u53d6\u6d88\u7684\u4e0a\u4e0b\u6587\r\n            newCtx := context.Background()\r\n\r\n            // \u5ef6\u8fdf\u4e00\u6bb5\u65f6\u95f4\u518d\u5199\u5165\u6570\u636e\u6e90\r\n            time.Sleep(w.options.WriteDelay)\r\n\r\n            // \u66f4\u65b0\u6570\u636e\u6e90\r\n            if err := w.dataSource.Store(newCtx, key, value); err != nil {\r\n                // \u5b9e\u9645\u5e94\u7528\u4e2d\u5e94\u5f53\u6709\u9519\u8bef\u5904\u7406\u65e5\u5fd7\r\n            }\r\n        }()\r\n\r\n        return nil\r\n    }\r\n\r\n    // \u6807\u51c6Write Through\uff1a\u540c\u65f6\u66f4\u65b0\u6570\u636e\u6e90\u548c\u7f13\u5b58\r\n    // \u5148\u66f4\u65b0\u6570\u636e\u6e90\r\n    if err := w.dataSource.Store(ctx, key, value); err != nil {\r\n        return fmt.Errorf("failed to store in data source: %w", err)\r\n    }\r\n\r\n    // \u518d\u66f4\u65b0\u7f13\u5b58\r\n    if err := w.cache.Set(ctx, key, value, expiration); err != nil {\r\n        // \u6570\u636e\u6e90\u5df2\u66f4\u65b0\uff0c\u4f46\u7f13\u5b58\u66f4\u65b0\u5931\u8d25\r\n        // \u6b64\u65f6\u9700\u8981\u79fb\u9664\u7f13\u5b58\u9879\u4ee5\u907f\u514d\u4e0d\u4e00\u81f4\r\n        _ = w.cache.Del(ctx, key)\r\n        return fmt.Errorf("data source updated but cache set failed: %w", err)\r\n    }\r\n\r\n    return nil\r\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u4f7f\u7528\u793a\u4f8b-1",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// \u521b\u5efa Write-Through \u7b56\u7565\r\nwriteThrough := consistency.NewWriteThroughStrategy(\r\n    memCache,\r\n    userDB,\r\n    consistency.WithWriteThroughTTL(10*time.Minute),\r\n    consistency.WithDelayedWrite(true, 100*time.Millisecond), // \u4f7f\u7528\u5ef6\u8fdf\u5199\u5165\r\n)\r\n\r\n// \u4f7f\u7528\u7b56\u7565\u5199\u5165\uff0c\u4f1a\u5148\u5199\u7f13\u5b58\uff0c\u5ef6\u8fdf\u5199\u5165\u6570\u636e\u6e90\r\nerr := writeThrough.Set(ctx, "user:1004", "Alice Green", 10*time.Minute)\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u914d\u7f6e\u9009\u9879-1",children:"\u914d\u7f6e\u9009\u9879"}),"\n",(0,i.jsx)(e.p,{children:"Write-Through \u7b56\u7565\u652f\u6301\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// WithWriteThroughTTL \u8bbe\u7f6e Write Through \u7b56\u7565\u7684\u9ed8\u8ba4TTL\r\nfunc WithWriteThroughTTL(ttl time.Duration) Option {\r\n    return func(o interface{}) {\r\n        if wt, ok := o.(*WriteThroughOptions); ok {\r\n            wt.DefaultTTL = ttl\r\n        }\r\n    }\r\n}\r\n\r\n// WithDelayedWrite \u8bbe\u7f6e\u662f\u5426\u4f7f\u7528\u5ef6\u8fdf\u5199\u5165\u53ca\u5ef6\u8fdf\u65f6\u95f4\r\nfunc WithDelayedWrite(delayed bool, delay time.Duration) Option {\r\n    return func(o interface{}) {\r\n        if wt, ok := o.(*WriteThroughOptions); ok {\r\n            wt.DelayedWrite = delayed\r\n            if delay > 0 {\r\n                wt.WriteDelay = delay\r\n            }\r\n        }\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u57fa\u4e8e\u6d88\u606f\u961f\u5217\u7684\u901a\u77e5\u7b56\u7565",children:"\u57fa\u4e8e\u6d88\u606f\u961f\u5217\u7684\u901a\u77e5\u7b56\u7565"}),"\n",(0,i.jsx)(e.p,{children:"MQNotifierStrategy\uff08\u6d88\u606f\u961f\u5217\u901a\u77e5\u7b56\u7565\uff09\u5229\u7528\u6d88\u606f\u961f\u5217\u5728\u5206\u5e03\u5f0f\u73af\u5883\u4e2d\u4f20\u64ad\u7f13\u5b58\u53d8\u66f4\uff0c\u786e\u4fdd\u591a\u4e2a\u7f13\u5b58\u8282\u70b9\u7684\u4e00\u81f4\u6027\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u7f13\u5b58\u66f4\u6539\u65f6\u53d1\u9001\u6d88\u606f\u901a\u77e5\u5176\u4ed6\u8282\u70b9"}),"\n",(0,i.jsx)(e.li,{children:"\u63a5\u6536\u8282\u70b9\u6839\u636e\u6d88\u606f\u7c7b\u578b\u91c7\u53d6\u76f8\u5e94\u64cd\u4f5c\uff08\u66f4\u65b0\u6216\u5931\u6548\uff09"}),"\n",(0,i.jsx)(e.li,{children:"\u652f\u6301\u6d88\u606f\u91cd\u4f20\u548c\u5931\u8d25\u6062\u590d"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"\u5b9e\u73b0\u7ec6\u8282-2",children:"\u5b9e\u73b0\u7ec6\u8282"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// NewMQNotifierStrategy \u521b\u5efa\u57fa\u4e8e\u6d88\u606f\u961f\u5217\u901a\u77e5\u7684\u4e00\u81f4\u6027\u7b56\u7565\r\nfunc NewMQNotifierStrategy(cache cache.Cache, dataSource DataSource, publisher MessagePublisher, opts ...Option) *MQNotifierStrategy {\r\n    options := defaultMQNotifierOptions()\r\n\r\n    // \u5e94\u7528\u9009\u9879\r\n    for _, opt := range opts {\r\n        opt(options)\r\n    }\r\n\r\n    strategy := &MQNotifierStrategy{\r\n        cache:      cache,\r\n        dataSource: dataSource,\r\n        publisher:  publisher,\r\n        options:    options,\r\n    }\r\n\r\n    // \u81ea\u52a8\u8ba2\u9605\u6d88\u606f\u5904\u7406\r\n    err := publisher.Subscribe(options.Topic, strategy.handleMessage)\r\n    if err != nil {\r\n        // \u5b9e\u9645\u5e94\u7528\u5e94\u5f53\u6709\u65e5\u5fd7\u8bb0\u5f55\r\n    }\r\n\r\n    return strategy\r\n}\n"})}),"\n",(0,i.jsx)(e.h4,{id:"\u53d1\u5e03\u7f13\u5b58\u66f4\u65b0\u6d88\u606f",children:"\u53d1\u5e03\u7f13\u5b58\u66f4\u65b0\u6d88\u606f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// publishWithRetry \u5c1d\u8bd5\u53d1\u5e03\u6d88\u606f\uff0c\u652f\u6301\u91cd\u8bd5\r\nfunc (m *MQNotifierStrategy) publishWithRetry(ctx context.Context, message CacheMessage) error {\r\n    // \u5e8f\u5217\u5316\u6d88\u606f\r\n    msgBytes, err := json.Marshal(message)\r\n    if err != nil {\r\n        return fmt.Errorf("failed to marshal cache message: %w", err)\r\n    }\r\n\r\n    // \u7b2c\u4e00\u6b21\u5c1d\u8bd5\r\n    err = m.publisher.Publish(ctx, m.options.Topic, msgBytes)\r\n    if err == nil {\r\n        return nil\r\n    }\r\n\r\n    // \u5931\u8d25\u540e\u8fdb\u884c\u91cd\u8bd5\r\n    retries := 0\r\n    for retries < m.options.MaxRetries {\r\n        // \u7b49\u5f85\u91cd\u8bd5\u95f4\u9694\r\n        time.Sleep(m.options.RetryDelay)\r\n        \r\n        // \u518d\u6b21\u5c1d\u8bd5\r\n        err = m.publisher.Publish(ctx, m.options.Topic, msgBytes)\r\n        if err == nil {\r\n            return nil\r\n        }\r\n        \r\n        retries++\r\n    }\r\n    \r\n    return fmt.Errorf("failed to publish message after %d retries: %w", m.options.MaxRetries, err)\r\n}\n'})}),"\n",(0,i.jsx)(e.h4,{id:"\u5904\u7406\u63a5\u6536\u5230\u7684\u6d88\u606f",children:"\u5904\u7406\u63a5\u6536\u5230\u7684\u6d88\u606f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// handleMessage \u5904\u7406\u63a5\u6536\u5230\u7684\u7f13\u5b58\u6d88\u606f\r\nfunc (m *MQNotifierStrategy) handleMessage(msg []byte) {\r\n    var message CacheMessage\r\n    err := json.Unmarshal(msg, &message)\r\n    if err != nil {\r\n        // \u65e5\u5fd7\u8bb0\u5f55\u89e3\u6790\u9519\u8bef\r\n        log.Printf("Failed to unmarshal cache message: %v", err)\r\n        return\r\n    }\r\n\r\n    // \u521b\u5efa\u5e26\u8d85\u65f6\u7684\u4e0a\u4e0b\u6587\r\n    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)\r\n    defer cancel()\r\n\r\n    switch message.Type {\r\n    case MsgTypeInvalidate:\r\n        // \u5904\u7406\u7f13\u5b58\u5931\u6548\u6d88\u606f\r\n        _ = m.cache.Del(ctx, message.Key)\r\n        \r\n    case MsgTypeUpdate:\r\n        // \u5904\u7406\u7f13\u5b58\u66f4\u65b0\u6d88\u606f\r\n        if len(message.Data) > 0 {\r\n            var value interface{}\r\n            // \u5c1d\u8bd5\u53cd\u5e8f\u5217\u5316\u503c\r\n            if err := json.Unmarshal(message.Data, &value); err == nil {\r\n                _ = m.cache.Set(ctx, message.Key, value, m.options.DefaultTTL)\r\n            }\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u4f7f\u7528\u793a\u4f8b-2",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// \u7b80\u5355\u5b9e\u73b0\u4e00\u4e2a\u6d88\u606f\u53d1\u5e03\u8005\r\ntype SimplePublisher struct {\r\n    subscribers []func([]byte)\r\n}\r\n\r\nfunc (p *SimplePublisher) Publish(ctx context.Context, topic string, msg []byte) error {\r\n    for _, sub := range p.subscribers {\r\n        sub(msg)\r\n    }\r\n    return nil\r\n}\r\n\r\nfunc (p *SimplePublisher) Subscribe(topic string, handler func(msg []byte)) error {\r\n    p.subscribers = append(p.subscribers, handler)\r\n    return nil\r\n}\r\n\r\nfunc (p *SimplePublisher) Close() error {\r\n    return nil\r\n}\r\n\r\n// \u521b\u5efa\u53d1\u5e03\u8005\r\npublisher := &SimplePublisher{}\r\n\r\n// \u521b\u5efa\u57fa\u4e8e\u6d88\u606f\u961f\u5217\u7684\u901a\u77e5\u7b56\u7565\r\nmqStrategy := consistency.NewMQNotifierStrategy(\r\n    memCache,\r\n    userDB,\r\n    publisher,\r\n    consistency.WithMQTopic("cache:invalidate"),\r\n    consistency.WithMQNotifierTTL(10*time.Minute),\r\n)\r\n\r\n// \u4f7f\u7528\u7b56\u7565\uff0c\u5199\u5165\u6216\u5220\u9664\u64cd\u4f5c\u4f1a\u901a\u8fc7\u6d88\u606f\u961f\u5217\u901a\u77e5\u5176\u4ed6\u8282\u70b9\r\nerr := mqStrategy.Set(ctx, "user:1005", "Tom Wilson", 10*time.Minute)\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u914d\u7f6e\u9009\u9879-2",children:"\u914d\u7f6e\u9009\u9879"}),"\n",(0,i.jsx)(e.p,{children:"MQ\u901a\u77e5\u7b56\u7565\u652f\u6301\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"// WithMQTopic \u8bbe\u7f6e\u6d88\u606f\u4e3b\u9898\r\nfunc WithMQTopic(topic string) Option {\r\n    return func(o interface{}) {\r\n        if mq, ok := o.(*MQNotifierOptions); ok {\r\n            mq.Topic = topic\r\n        }\r\n    }\r\n}\r\n\r\n// WithMQRetry \u8bbe\u7f6e\u91cd\u8bd5\u7b56\u7565\r\nfunc WithMQRetry(maxRetries int, retryDelay time.Duration) Option {\r\n    return func(o interface{}) {\r\n        if mq, ok := o.(*MQNotifierOptions); ok {\r\n            if maxRetries >= 0 {\r\n                mq.MaxRetries = maxRetries\r\n            }\r\n            if retryDelay > 0 {\r\n                mq.RetryDelay = retryDelay\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// WithMQNotifierTTL \u8bbe\u7f6e MQ \u901a\u77e5\u5668\u7684\u9ed8\u8ba4TTL\r\nfunc WithMQNotifierTTL(ttl time.Duration) Option {\r\n    return func(o interface{}) {\r\n        if mq, ok := o.(*MQNotifierOptions); ok {\r\n            mq.DefaultTTL = ttl\r\n        }\r\n    }\r\n}\n"})})]})}function u(r={}){const{wrapper:e}={...(0,c.R)(),...r.components};return e?(0,i.jsx)(e,{...r,children:(0,i.jsx)(h,{...r})}):h(r)}},8453:(r,e,n)=>{n.d(e,{R:()=>a,x:()=>s});var t=n(6540);const i={},c=t.createContext(i);function a(r){const e=t.useContext(c);return t.useMemo((function(){return"function"==typeof r?r(e):{...e,...r}}),[e,r])}function s(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(i):r.components||i:a(r.components),t.createElement(c.Provider,{value:e},r.children)}}}]);