"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[739],{6021:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>l,toc:()=>d});const l=JSON.parse('{"id":"cluster-management/replication","title":"Data Replication","description":"\u6570\u636e\u590d\u5236\u662f FyerCache \u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u4fdd\u8bc1\u6570\u636e\u53ef\u9760\u6027\u548c\u9ad8\u53ef\u7528\u6027\u7684\u5173\u952e\u673a\u5236\u3002","source":"@site/docs/cluster-management/replication.md","sourceDirName":"cluster-management","slug":"/cluster-management/replication","permalink":"/fyer-cache/docs/cluster-management/replication","draft":false,"unlisted":false,"editUrl":"https://github.com/fyerfyer/fyer-rpc/tree/main/docs/cluster-management/replication.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Membership Management","permalink":"/fyer-cache/docs/cluster-management/membership"},"next":{"title":"System Architecture & Design Principles","permalink":"/fyer-cache/docs/core-concepts/architecture"}}');var t=n(4848),i=n(8453);const o={},c="Data Replication",a={},d=[{value:"\u590d\u5236\u67b6\u6784\u6982\u8ff0",id:"\u590d\u5236\u67b6\u6784\u6982\u8ff0",level:2},{value:"\u6838\u5fc3\u7ec4\u4ef6",id:"\u6838\u5fc3\u7ec4\u4ef6",level:2},{value:"1. \u590d\u5236\u65e5\u5fd7\uff08ReplicationLog\uff09",id:"1-\u590d\u5236\u65e5\u5fd7replicationlog",level:3},{value:"2. \u540c\u6b65\u5668\uff08Syncer\uff09",id:"2-\u540c\u6b65\u5668syncer",level:3},{value:"3. \u9886\u5bfc\u8005\u8282\u70b9\uff08LeaderNode\uff09",id:"3-\u9886\u5bfc\u8005\u8282\u70b9leadernode",level:3},{value:"4. \u8ddf\u968f\u8005\u8282\u70b9\uff08FollowerNode\uff09",id:"4-\u8ddf\u968f\u8005\u8282\u70b9followernode",level:3},{value:"\u590d\u5236\u5de5\u4f5c\u6d41\u7a0b",id:"\u590d\u5236\u5de5\u4f5c\u6d41\u7a0b",level:2},{value:"\u5199\u64cd\u4f5c\u6d41\u7a0b",id:"\u5199\u64cd\u4f5c\u6d41\u7a0b",level:3},{value:"\u8bfb\u64cd\u4f5c\u6d41\u7a0b",id:"\u8bfb\u64cd\u4f5c\u6d41\u7a0b",level:3},{value:"\u540c\u6b65\u6d41\u7a0b",id:"\u540c\u6b65\u6d41\u7a0b",level:3},{value:"1. \u589e\u91cf\u540c\u6b65",id:"1-\u589e\u91cf\u540c\u6b65",level:4},{value:"2. \u5168\u91cf\u540c\u6b65",id:"2-\u5168\u91cf\u540c\u6b65",level:4},{value:"\u6545\u969c\u68c0\u6d4b\u4e0e\u6062\u590d",id:"\u6545\u969c\u68c0\u6d4b\u4e0e\u6062\u590d",level:2},{value:"\u5fc3\u8df3\u673a\u5236",id:"\u5fc3\u8df3\u673a\u5236",level:3},{value:"\u9886\u5bfc\u8005\u6545\u969c\u5904\u7406",id:"\u9886\u5bfc\u8005\u6545\u969c\u5904\u7406",level:3},{value:"\u4e3b\u4ece\u96c6\u7fa4\u96c6\u6210",id:"\u4e3b\u4ece\u96c6\u7fa4\u96c6\u6210",level:2},{value:"\u914d\u7f6e\u9009\u9879",id:"\u914d\u7f6e\u9009\u9879",level:2},{value:"\u5173\u952e\u914d\u7f6e\u53c2\u6570",id:"\u5173\u952e\u914d\u7f6e\u53c2\u6570",level:3},{value:"\u5b9e\u9645\u5e94\u7528\u793a\u4f8b",id:"\u5b9e\u9645\u5e94\u7528\u793a\u4f8b",level:2},{value:"\u57fa\u672c\u4e3b\u4ece\u590d\u5236\u8bbe\u7f6e",id:"\u57fa\u672c\u4e3b\u4ece\u590d\u5236\u8bbe\u7f6e",level:3},{value:"\u96c6\u6210\u4e3b\u4ece\u590d\u5236\u548c\u96c6\u7fa4\u7ba1\u7406",id:"\u96c6\u6210\u4e3b\u4ece\u590d\u5236\u548c\u96c6\u7fa4\u7ba1\u7406",level:3}];function s(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"data-replication",children:"Data Replication"})}),"\n",(0,t.jsx)(r.p,{children:"\u6570\u636e\u590d\u5236\u662f FyerCache \u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u4fdd\u8bc1\u6570\u636e\u53ef\u9760\u6027\u548c\u9ad8\u53ef\u7528\u6027\u7684\u5173\u952e\u673a\u5236\u3002"}),"\n",(0,t.jsx)(r.h2,{id:"\u590d\u5236\u67b6\u6784\u6982\u8ff0",children:"\u590d\u5236\u67b6\u6784\u6982\u8ff0"}),"\n",(0,t.jsx)(r.p,{children:"FyerCache \u5b9e\u73b0\u4e86\u57fa\u4e8e\u9886\u5bfc\u8005-\u8ddf\u968f\u8005\uff08Leader-Follower\uff09\u7684\u6570\u636e\u590d\u5236\u67b6\u6784\uff0c\u5177\u6709\u4ee5\u4e0b\u7279\u70b9\uff1a"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u4e3b\u4ece\u6a21\u5f0f"})," - \u4e00\u4e2a\u4e3b\u8282\u70b9\uff08Leader\uff09\u5904\u7406\u5199\u64cd\u4f5c\uff0c\u591a\u4e2a\u4ece\u8282\u70b9\uff08Follower\uff09\u63d0\u4f9b\u8bfb\u670d\u52a1"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u590d\u5236\u65e5\u5fd7"})," - \u8bb0\u5f55\u6240\u6709\u4fee\u6539\u64cd\u4f5c\uff0c\u7528\u4e8e\u6570\u636e\u540c\u6b65\u548c\u4e00\u81f4\u6027\u4fdd\u8bc1"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u589e\u91cf\u540c\u6b65"})," - \u6b63\u5e38\u60c5\u51b5\u4e0b\u53ea\u4f20\u8f93\u65b0\u7684\u53d8\u66f4"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u5168\u91cf\u540c\u6b65"})," - \u65b0\u8282\u70b9\u52a0\u5165\u6216\u957f\u65f6\u95f4\u65ad\u8fde\u540e\u8fdb\u884c\u5b8c\u6574\u6570\u636e\u540c\u6b65"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u6545\u969c\u68c0\u6d4b\u4e0e\u6062\u590d"})," - \u81ea\u52a8\u68c0\u6d4b\u8282\u70b9\u6545\u969c\u5e76\u8fdb\u884c\u9002\u5f53\u5904\u7406"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"\u67b6\u6784\u7ec4\u4ef6\u5173\u7cfb\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502            \u2502             \u2502            \u2502\r\n\u2502   Leader   \u2502\u2500\u2500\u590d\u5236\u65e5\u5fd7\u2500\u2500\u25b6\u2502  Follower  \u2502\r\n\u2502            \u2502\u25c0\u2500\u2500\u5fc3\u8df3\u54cd\u5e94\u2500\u2500\u2502            \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n      \u2502                          \u2502\r\n      \u2502                          \u2502\r\n      \u25bc                          \u25bc\r\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n\u2502            \u2502             \u2502            \u2502\r\n\u2502  \u672c\u5730\u7f13\u5b58   \u2502             \u2502  \u672c\u5730\u7f13\u5b58   \u2502\r\n\u2502            \u2502             \u2502            \u2502\r\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(r.h2,{id:"\u6838\u5fc3\u7ec4\u4ef6",children:"\u6838\u5fc3\u7ec4\u4ef6"}),"\n",(0,t.jsx)(r.h3,{id:"1-\u590d\u5236\u65e5\u5fd7replicationlog",children:"1. \u590d\u5236\u65e5\u5fd7\uff08ReplicationLog\uff09"}),"\n",(0,t.jsx)(r.p,{children:"\u590d\u5236\u65e5\u5fd7\u8bb0\u5f55\u6240\u6709\u5199\u64cd\u4f5c\uff0c\u662f\u6570\u636e\u590d\u5236\u7684\u57fa\u7840\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// ReplicationEntry \u590d\u5236\u65e5\u5fd7\u6761\u76ee\r\ntype ReplicationEntry struct {\r\n    Index      uint64        // \u65e5\u5fd7\u7d22\u5f15\r\n    Term       uint64        // \u4efb\u671f\u53f7\r\n    Command    string        // \u547d\u4ee4\u7c7b\u578b (Set, Del)\r\n    Key        string        // \u7f13\u5b58\u952e\r\n    Value      []byte        // \u7f13\u5b58\u503c\r\n    Expiration time.Duration // \u8fc7\u671f\u65f6\u95f4\r\n    Timestamp  time.Time     // \u64cd\u4f5c\u65f6\u95f4\u6233\r\n    ValueType  string        // \u5b58\u50a8\u503c\u7c7b\u578b\r\n}\n"})}),"\n",(0,t.jsxs)(r.p,{children:["FyerCache \u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e\u5185\u5b58\u7684\u65e5\u5fd7\u5b9e\u73b0 ",(0,t.jsx)(r.code,{children:"MemoryReplicationLog"}),"\uff0c\u652f\u6301\u4ee5\u4e0b\u64cd\u4f5c\uff1a"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u8ffd\u52a0\u65e5\u5fd7"}),"\uff1a\u8bb0\u5f55\u65b0\u7684\u64cd\u4f5c"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u83b7\u53d6\u65e5\u5fd7"}),"\uff1a\u6309\u7d22\u5f15\u67e5\u8be2\u65e5\u5fd7\u6761\u76ee"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u6279\u91cf\u83b7\u53d6"}),"\uff1a\u83b7\u53d6\u4e00\u5b9a\u8303\u56f4\u7684\u65e5\u5fd7\u6761\u76ee\uff0c\u7528\u4e8e\u540c\u6b65"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u622a\u65ad\u65e5\u5fd7"}),"\uff1a\u79fb\u9664\u65e7\u65e5\u5fd7\uff0c\u8282\u7701\u5185\u5b58\u7a7a\u95f4"]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'// NewMemoryReplicationLog \u521b\u5efa\u65b0\u7684\u5185\u5b58\u590d\u5236\u65e5\u5fd7\r\nlog := replication.NewMemoryReplicationLog()\r\n\r\n// \u8ffd\u52a0\u65e5\u5fd7\u6761\u76ee\r\nentry := &replication.ReplicationEntry{\r\n    Command: "Set",\r\n    Key:     "user:1001",\r\n    Value:   []byte(`{"name":"John","age":30}`),\r\n    Term:    1,\r\n}\r\nlog.Append(entry)\n'})}),"\n",(0,t.jsx)(r.h3,{id:"2-\u540c\u6b65\u5668syncer",children:"2. \u540c\u6b65\u5668\uff08Syncer\uff09"}),"\n",(0,t.jsx)(r.p,{children:"\u540c\u6b65\u5668\u8d1f\u8d23\u5728\u8282\u70b9\u95f4\u4f20\u8f93\u548c\u5e94\u7528\u6570\u636e\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// Syncer \u6570\u636e\u540c\u6b65\u63a5\u53e3\r\ntype Syncer interface {\r\n    // \u8bb0\u5f55\u8bbe\u7f6e\u64cd\u4f5c\u5230\u65e5\u5fd7\r\n    RecordSetOperation(key string, value []byte, expiration time.Duration, term uint64) error\r\n    \r\n    // \u8bb0\u5f55\u5220\u9664\u64cd\u4f5c\u5230\u65e5\u5fd7\r\n    RecordDelOperation(key string, term uint64) error\r\n    \r\n    // \u542f\u52a8\u540c\u6b65\u5668\r\n    Start() error\r\n    \r\n    // \u505c\u6b62\u540c\u6b65\u5668\r\n    Stop() error\r\n    \r\n    // \u6267\u884c\u5168\u91cf\u540c\u6b65\r\n    FullSync(ctx context.Context, target string) error\r\n    \r\n    // \u6267\u884c\u589e\u91cf\u540c\u6b65\r\n    IncrementalSync(ctx context.Context, target string, startIndex uint64) error\r\n    \r\n    // \u5e94\u7528\u540c\u6b65\u6570\u636e\r\n    ApplySync(ctx context.Context, entries []*ReplicationEntry) error\r\n}\n"})}),"\n",(0,t.jsxs)(r.p,{children:["FyerCache \u7684\u9ed8\u8ba4\u5b9e\u73b0 ",(0,t.jsx)(r.code,{children:"MemorySyncer"})," \u901a\u8fc7 HTTP \u63d0\u4f9b\u540c\u6b65\u670d\u52a1\uff1a"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'syncer := replication.NewMemorySyncer(\r\n    "node-1",\r\n    localCache,\r\n    replicationLog,\r\n    replication.WithAddress("localhost:8080"),\r\n    replication.WithMaxRetries(3),\r\n)\r\nsyncer.Start()\n'})}),"\n",(0,t.jsx)(r.h3,{id:"3-\u9886\u5bfc\u8005\u8282\u70b9leadernode",children:"3. \u9886\u5bfc\u8005\u8282\u70b9\uff08LeaderNode\uff09"}),"\n",(0,t.jsx)(r.p,{children:"\u9886\u5bfc\u8005\u8282\u70b9\u8d1f\u8d23\u5904\u7406\u5199\u64cd\u4f5c\u5e76\u5c06\u53d8\u66f4\u590d\u5236\u5230\u8ddf\u968f\u8005\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// LeaderNode \u9886\u5bfc\u8005\u8282\u70b9\u63a5\u53e3\r\ntype LeaderNode interface {\r\n    // \u83b7\u53d6/\u8bbe\u7f6e\u8282\u70b9\u89d2\u8272\r\n    GetRole() ReplicationRole\r\n    SetRole(role ReplicationRole)\r\n    \r\n    // \u83b7\u53d6\u5f53\u524d\u9886\u5bfc\u8005ID\r\n    GetLeader() string\r\n    \r\n    // \u7ba1\u7406\u8ddf\u968f\u8005\u8282\u70b9\r\n    AddFollower(nodeID string, address string) error\r\n    RemoveFollower(nodeID string) error\r\n    GetFollowers() map[string]string\r\n    \r\n    // \u542f\u52a8\u548c\u505c\u6b62\u670d\u52a1\r\n    Start() error\r\n    Stop() error\r\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u9886\u5bfc\u8005\u8282\u70b9\u7ef4\u62a4\u4ece\u8282\u70b9\u5217\u8868\u5e76\u5904\u7406\u5fc3\u8df3\u901a\u4fe1\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'leader := replication.NewLeaderNode(\r\n    "leader-1",\r\n    localCache,\r\n    replicationLog,\r\n    syncer,\r\n    replication.WithHeartbeatInterval(500 * time.Millisecond),\r\n)\r\nleader.Start()\r\n\r\n// \u6dfb\u52a0\u4ece\u8282\u70b9\r\nleader.AddFollower("follower-1", "follower-1:8080")\n'})}),"\n",(0,t.jsx)(r.h3,{id:"4-\u8ddf\u968f\u8005\u8282\u70b9followernode",children:"4. \u8ddf\u968f\u8005\u8282\u70b9\uff08FollowerNode\uff09"}),"\n",(0,t.jsx)(r.p,{children:"\u8ddf\u968f\u8005\u8282\u70b9\u63a5\u6536\u6765\u81ea\u9886\u5bfc\u8005\u7684\u66f4\u65b0\u5e76\u5e94\u7528\u5230\u672c\u5730\u7f13\u5b58\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// FollowerNode \u8ddf\u968f\u8005\u8282\u70b9\u63a5\u53e3\r\ntype FollowerNode interface {\r\n    // \u83b7\u53d6/\u8bbe\u7f6e\u8282\u70b9\u89d2\u8272\r\n    GetRole() ReplicationRole\r\n    SetRole(role ReplicationRole)\r\n    \r\n    // \u83b7\u53d6/\u8bbe\u7f6e\u9886\u5bfc\u8005\r\n    GetLeader() string\r\n    SetLeader(leaderID string, leaderAddr string)\r\n    \r\n    // \u540c\u6b65\u64cd\u4f5c\r\n    SyncFromLeader(ctx context.Context) error\r\n    RequestFullSync(ctx context.Context) error\r\n    \r\n    // \u542f\u52a8\u548c\u505c\u6b62\u670d\u52a1\r\n    Start() error\r\n    Stop() error\r\n    \r\n    // \u5347\u7ea7\u4e3a\u9886\u5bfc\u8005\r\n    PromoteToLeader() error\r\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u8ddf\u968f\u8005\u8282\u70b9\u76d1\u63a7\u9886\u5bfc\u8005\u5fc3\u8df3\u5e76\u5904\u7406\u590d\u5236\u8bf7\u6c42\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'follower := replication.NewFollowerNode(\r\n    "follower-1",\r\n    localCache,\r\n    replicationLog,\r\n    syncer,\r\n    replication.WithElectionTimeout(2 * time.Second),\r\n)\r\nfollower.Start()\r\n\r\n// \u8bbe\u7f6e\u9886\u5bfc\u8005\r\nfollower.SetLeader("leader-1", "leader-1:8080")\r\n\r\n// \u4ece\u9886\u5bfc\u8005\u540c\u6b65\u6570\u636e\r\nfollower.SyncFromLeader(context.Background())\n'})}),"\n",(0,t.jsx)(r.h2,{id:"\u590d\u5236\u5de5\u4f5c\u6d41\u7a0b",children:"\u590d\u5236\u5de5\u4f5c\u6d41\u7a0b"}),"\n",(0,t.jsx)(r.h3,{id:"\u5199\u64cd\u4f5c\u6d41\u7a0b",children:"\u5199\u64cd\u4f5c\u6d41\u7a0b"}),"\n",(0,t.jsx)(r.p,{children:"\u5f53\u5ba2\u6237\u7aef\u53d1\u8d77\u5199\u64cd\u4f5c\uff08Set/Del\uff09\u65f6\uff1a"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u9886\u5bfc\u8005\u5904\u7406\u8bf7\u6c42"}),"\uff1a\u5199\u64cd\u4f5c\u5fc5\u987b\u53d1\u9001\u5230\u9886\u5bfc\u8005\u8282\u70b9"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u65e5\u5fd7\u8bb0\u5f55"}),"\uff1a\u9886\u5bfc\u8005\u5c06\u64cd\u4f5c\u8bb0\u5f55\u5230\u590d\u5236\u65e5\u5fd7"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u5e94\u7528\u672c\u5730"}),"\uff1a\u9886\u5bfc\u8005\u5c06\u64cd\u4f5c\u5e94\u7528\u5230\u81ea\u5df1\u7684\u672c\u5730\u7f13\u5b58"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u5e76\u884c\u590d\u5236"}),"\uff1a\u9886\u5bfc\u8005\u5c06\u65e5\u5fd7\u6761\u76ee\u5e76\u884c\u53d1\u9001\u7ed9\u6240\u6709\u8ddf\u968f\u8005"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u786e\u8ba4\u5b8c\u6210"}),"\uff1a\u5f53\u5927\u591a\u6570\u8282\u70b9\u786e\u8ba4\u63a5\u6536\u540e\uff0c\u64cd\u4f5c\u88ab\u89c6\u4e3a\u6301\u4e45\u5316"]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// Leader \u8282\u70b9\u5904\u7406 Set \u64cd\u4f5c\r\nfunc (l *LeaderNodeImpl) Set(ctx context.Context, key string, value interface{}, expiration time.Duration) error {\r\n    // 1. \u5e94\u7528\u5230\u672c\u5730\u7f13\u5b58\r\n    err := l.cache.Set(ctx, key, value, expiration)\r\n    if err != nil {\r\n        return err\r\n    }\r\n    \r\n    // 2. \u8bb0\u5f55\u5230\u590d\u5236\u65e5\u5fd7\u5e76\u590d\u5236\u5230\u4ece\u8282\u70b9\r\n    valueBytes, _ := json.Marshal(value)\r\n    err = l.syncer.RecordSetOperation(key, valueBytes, expiration, l.currentTerm)\r\n    if err != nil {\r\n        return err\r\n    }\r\n    \r\n    // 3. \u89e6\u53d1\u590d\u5236\u5230\u6240\u6709\u4ece\u8282\u70b9\r\n    go l.ReplicateEntries()\r\n    \r\n    return nil\r\n}\n"})}),"\n",(0,t.jsx)(r.h3,{id:"\u8bfb\u64cd\u4f5c\u6d41\u7a0b",children:"\u8bfb\u64cd\u4f5c\u6d41\u7a0b"}),"\n",(0,t.jsx)(r.p,{children:"\u8bfb\u64cd\u4f5c\u53ef\u4ee5\u7531\u4efb\u4f55\u8282\u70b9\u5904\u7406\uff0c\u4f46\u5b58\u5728\u4e00\u81f4\u6027\u5dee\u5f02\uff1a"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u4ece\u9886\u5bfc\u8005\u8bfb\u53d6"}),"\uff1a\u4fdd\u8bc1\u6700\u5f3a\u4e00\u81f4\u6027\uff0c\u4f46\u53ef\u80fd\u589e\u52a0\u9886\u5bfc\u8005\u8d1f\u8f7d"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u4ece\u8ddf\u968f\u8005\u8bfb\u53d6"}),"\uff1a\u63d0\u4f9b\u66f4\u597d\u7684\u6269\u5c55\u6027\uff0c\u4f46\u53ef\u80fd\u8fd4\u56de\u7a0d\u65e7\u7684\u6570\u636e\uff08\u6700\u7ec8\u4e00\u81f4\u6027\uff09"]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// \u4ece\u4efb\u610f\u8282\u70b9\u8bfb\u53d6\u6570\u636e\r\nfunc (n *ReplicationNode) Get(ctx context.Context, key string) (interface{}, error) {\r\n    // \u76f4\u63a5\u4ece\u672c\u5730\u7f13\u5b58\u8bfb\u53d6\r\n    return n.cache.Get(ctx, key)\r\n}\n"})}),"\n",(0,t.jsx)(r.h3,{id:"\u540c\u6b65\u6d41\u7a0b",children:"\u540c\u6b65\u6d41\u7a0b"}),"\n",(0,t.jsx)(r.p,{children:"FyerCache \u652f\u6301\u4e24\u79cd\u540c\u6b65\u6a21\u5f0f\uff1a"}),"\n",(0,t.jsx)(r.h4,{id:"1-\u589e\u91cf\u540c\u6b65",children:"1. \u589e\u91cf\u540c\u6b65"}),"\n",(0,t.jsx)(r.p,{children:"\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u8ddf\u968f\u8005\u53ea\u9700\u83b7\u53d6\u81ea\u4e0a\u6b21\u540c\u6b65\u540e\u7684\u65b0\u65e5\u5fd7\u6761\u76ee\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'// \u8ddf\u968f\u8005\u6267\u884c\u589e\u91cf\u540c\u6b65\r\nfunc (f *FollowerNodeImpl) SyncFromLeader(ctx context.Context) error {\r\n    if f.leaderAddr == "" {\r\n        return errors.New("no leader available")\r\n    }\r\n    \r\n    // \u83b7\u53d6\u672c\u5730\u6700\u540e\u65e5\u5fd7\u7d22\u5f15\r\n    lastIndex := f.log.GetLastIndex()\r\n    \r\n    // \u4ece Leader \u589e\u91cf\u540c\u6b65\u6570\u636e\r\n    return f.syncer.IncrementalSync(ctx, f.leaderAddr, lastIndex)\r\n}\n'})}),"\n",(0,t.jsx)(r.h4,{id:"2-\u5168\u91cf\u540c\u6b65",children:"2. \u5168\u91cf\u540c\u6b65"}),"\n",(0,t.jsx)(r.p,{children:"\u5728\u4ee5\u4e0b\u60c5\u51b5\u4e0b\u6267\u884c\u5168\u91cf\u540c\u6b65\uff1a"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u65b0\u8282\u70b9\u52a0\u5165\u96c6\u7fa4"}),"\n",(0,t.jsx)(r.li,{children:"\u8282\u70b9\u957f\u65f6\u95f4\u65ad\u8fde\u540e\u91cd\u65b0\u8fde\u63a5"}),"\n",(0,t.jsx)(r.li,{children:"\u65e5\u5fd7\u4e0d\u4e00\u81f4\u9700\u8981\u5b8c\u5168\u91cd\u5efa"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'// \u8ddf\u968f\u8005\u8bf7\u6c42\u5168\u91cf\u540c\u6b65\r\nfunc (f *FollowerNodeImpl) RequestFullSync(ctx context.Context) error {\r\n    if f.leaderAddr == "" {\r\n        return errors.New("no leader available")\r\n    }\r\n    \r\n    // \u8bf7\u6c42\u5e76\u5e94\u7528\u5b8c\u6574\u6570\u636e\r\n    return f.syncer.FullSync(ctx, f.leaderAddr)\r\n}\n'})}),"\n",(0,t.jsx)(r.h2,{id:"\u6545\u969c\u68c0\u6d4b\u4e0e\u6062\u590d",children:"\u6545\u969c\u68c0\u6d4b\u4e0e\u6062\u590d"}),"\n",(0,t.jsx)(r.h3,{id:"\u5fc3\u8df3\u673a\u5236",children:"\u5fc3\u8df3\u673a\u5236"}),"\n",(0,t.jsx)(r.p,{children:"\u9886\u5bfc\u8005\u5b9a\u671f\u5411\u8ddf\u968f\u8005\u53d1\u9001\u5fc3\u8df3\uff0c\u786e\u8ba4\u8fde\u63a5\u72b6\u6001\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// \u9886\u5bfc\u8005\u53d1\u9001\u5fc3\u8df3\r\nfunc (l *LeaderNodeImpl) startHeartbeat() {\r\n    ticker := time.NewTicker(l.config.HeartbeatInterval)\r\n    defer ticker.Stop()\r\n    \r\n    for {\r\n        select {\r\n        case <-ticker.C:\r\n            l.SendHeartbeat()\r\n        case <-l.stopCh:\r\n            return\r\n        }\r\n    }\r\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u8ddf\u968f\u8005\u76d1\u63a7\u5fc3\u8df3\uff0c\u68c0\u6d4b\u9886\u5bfc\u8005\u6545\u969c\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// \u8ddf\u968f\u8005\u76d1\u63a7\u5fc3\u8df3\r\nfunc (f *FollowerNodeImpl) startHeartbeatMonitor() {\r\n    f.heartbeatTimer = time.AfterFunc(f.heartbeatTimeout, func() {\r\n        // \u68c0\u67e5\u6700\u540e\u4e00\u6b21\u5fc3\u8df3\u65f6\u95f4\r\n        f.mu.RLock()\r\n        elapsed := time.Since(f.lastHeartbeat)\r\n        f.mu.RUnlock()\r\n        \r\n        // \u5982\u679c\u8d85\u8fc7\u8d85\u65f6\u65f6\u95f4\u672a\u6536\u5230\u5fc3\u8df3\uff0c\u89e6\u53d1\u9009\u4e3e\r\n        if elapsed > f.heartbeatTimeout {\r\n            if f.onLeaderFail != nil {\r\n                f.onLeaderFail()\r\n            }\r\n        }\r\n    })\r\n}\n"})}),"\n",(0,t.jsx)(r.h3,{id:"\u9886\u5bfc\u8005\u6545\u969c\u5904\u7406",children:"\u9886\u5bfc\u8005\u6545\u969c\u5904\u7406"}),"\n",(0,t.jsx)(r.p,{children:"\u5f53\u9886\u5bfc\u8005\u6545\u969c\u65f6\uff1a"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u68c0\u6d4b\u5931\u6548"}),"\uff1a\u8ddf\u968f\u8005\u68c0\u6d4b\u5230\u5fc3\u8df3\u8d85\u65f6"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u89e6\u53d1\u56de\u8c03"}),"\uff1a\u8c03\u7528\u914d\u7f6e\u7684\u5931\u6548\u5904\u7406\u51fd\u6570"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"\u9009\u4e3e\u6d41\u7a0b"}),"\uff1a\u7531\u96c6\u6210\u65b9\u5b9e\u73b0\uff0c\u901a\u5e38\u57fa\u4e8e\u4f18\u5148\u7ea7\u6216\u5916\u90e8\u534f\u8c03"]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'// \u8bbe\u7f6e\u9886\u5bfc\u8005\u5931\u6548\u56de\u8c03\r\nfollower.SetElectionCallback(func() {\r\n    // \u8fd9\u91cc\u53ef\u4ee5\u5b9e\u73b0\u9009\u4e3e\u903b\u8f91\u6216\u901a\u77e5\u5916\u90e8\u7cfb\u7edf\r\n    // \u4f8b\u5982\u63d0\u5347\u5f53\u524d\u8282\u70b9\u4e3a\u9886\u5bfc\u8005\uff0c\u6216\u9009\u62e9\u65b0\u9886\u5bfc\u8005\r\n    log.Printf("Leader %s appears to have failed", follower.GetLeader())\r\n    \r\n    // \u5728 LeaderFollowerCluster \u4e2d\uff0c\u4f1a\u81ea\u52a8\u5904\u7406\u6545\u969c\u8f6c\u79fb\r\n    cluster.handleFailover()\r\n})\n'})}),"\n",(0,t.jsx)(r.h2,{id:"\u4e3b\u4ece\u96c6\u7fa4\u96c6\u6210",children:"\u4e3b\u4ece\u96c6\u7fa4\u96c6\u6210"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.code,{children:"LeaderFollowerCluster"})," \u7c7b\u96c6\u6210\u4e86\u4e3b\u4ece\u590d\u5236\u548c\u96c6\u7fa4\u7ba1\u7406\u529f\u80fd\uff1a"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'// \u521b\u5efa\u4e3b\u4ece\u96c6\u7fa4\u8282\u70b9\r\ncluster, err := integration.NewLeaderFollowerCluster(\r\n    "node-1",\r\n    "localhost:7946",  // \u96c6\u7fa4\u901a\u4fe1\u5730\u5740\r\n    localCache,        // \u672c\u5730\u7f13\u5b58\u5b9e\u4f8b\r\n    []cluster.NodeOption{\r\n        cluster.WithGossipInterval(500 * time.Millisecond),\r\n    },\r\n    []integration.LeaderFollowerClusterOption{\r\n        integration.WithSyncerAddress("localhost:8080"),  // \u540c\u6b65\u670d\u52a1\u5730\u5740\r\n        integration.WithInitialRole(replication.RoleLeader),  // \u521d\u59cb\u89d2\u8272\r\n    },\r\n)\r\n\r\n// \u542f\u52a8\u96c6\u7fa4\r\ncluster.Start()\r\n\r\n// \u7b2c\u4e00\u4e2a\u8282\u70b9\u81ea\u5f15\u5bfc\r\ncluster.Join("localhost:7946")\r\n\r\n// \u5176\u4ed6\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\r\notherCluster.Join("localhost:7946")\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u4e3b\u4ece\u96c6\u7fa4\u63d0\u4f9b\u81ea\u52a8\u6545\u969c\u8f6c\u79fb\u529f\u80fd\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// \u81ea\u52a8\u5904\u7406\u9886\u5bfc\u8005\u6545\u969c\r\nfunc (lfc *LeaderFollowerCluster) handleFailover() {\r\n    lfc.mu.Lock()\r\n    defer lfc.mu.Unlock()\r\n    \r\n    // \u68c0\u67e5\u5f53\u524d\u89d2\u8272\uff0c\u53ea\u6709\u8ddf\u968f\u8005\u624d\u80fd\u8fdb\u884c\u6545\u969c\u8f6c\u79fb\r\n    if lfc.currentRole != replication.RoleFollower {\r\n        return\r\n    }\r\n    \r\n    // \u6839\u636e\u6761\u4ef6\u51b3\u5b9a\u662f\u5426\u63d0\u5347\u4e3a\u9886\u5bfc\u8005\r\n    // \u4f8b\u5982\u4f18\u5148\u7ea7\u3001\u8282\u70b9ID\u7b49\r\n    shouldPromote := lfc.determineIfShouldPromote()\r\n    \r\n    if shouldPromote {\r\n        lfc.PromoteToLeader()\r\n    }\r\n}\n"})}),"\n",(0,t.jsx)(r.h2,{id:"\u914d\u7f6e\u9009\u9879",children:"\u914d\u7f6e\u9009\u9879"}),"\n",(0,t.jsx)(r.p,{children:"FyerCache \u63d0\u4f9b\u4e30\u5bcc\u7684\u6570\u636e\u590d\u5236\u914d\u7f6e\u9009\u9879\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"// \u590d\u5236\u914d\u7f6e\u9009\u9879\r\ntype ReplicationOption func(*ReplicationConfig)\r\n\r\n// \u793a\u4f8b\u914d\u7f6e\r\nleader := replication.NewLeaderNode(\r\n    nodeID,\r\n    cache,\r\n    log,\r\n    syncer,\r\n    // \u5fc3\u8df3\u95f4\u9694\r\n    replication.WithHeartbeatInterval(500 * time.Millisecond),\r\n    // \u9009\u4e3e\u8d85\u65f6\r\n    replication.WithElectionTimeout(2 * time.Second),\r\n    // \u6700\u5927\u65e5\u5fd7\u6761\u76ee\u6570\r\n    replication.WithMaxLogEntries(1000),\r\n    // \u5feb\u7167\u9608\u503c\r\n    replication.WithSnapshotThreshold(10000),\r\n    // \u91cd\u8bd5\u53c2\u6570\r\n    replication.WithMaxRetries(3),\r\n    replication.WithRetryInterval(200 * time.Millisecond),\r\n    // \u590d\u5236\u8d85\u65f6\r\n    replication.WithReplicationTimeout(5 * time.Second),\r\n    // \u9009\u4e3e\u4f18\u5148\u7ea7\r\n    replication.WithPriority(10),\r\n)\n"})}),"\n",(0,t.jsx)(r.h3,{id:"\u5173\u952e\u914d\u7f6e\u53c2\u6570",children:"\u5173\u952e\u914d\u7f6e\u53c2\u6570"}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"\u53c2\u6570"}),(0,t.jsx)(r.th,{children:"\u63cf\u8ff0"}),(0,t.jsx)(r.th,{children:"\u9ed8\u8ba4\u503c"}),(0,t.jsx)(r.th,{children:"\u5efa\u8bae\u503c"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"HeartbeatInterval"})}),(0,t.jsx)(r.td,{children:"\u9886\u5bfc\u8005\u53d1\u9001\u5fc3\u8df3\u7684\u95f4\u9694"}),(0,t.jsx)(r.td,{children:"500ms"}),(0,t.jsx)(r.td,{children:"200ms-1s\uff0c\u6839\u636e\u7f51\u7edc\u7a33\u5b9a\u6027\u8c03\u6574"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"ElectionTimeout"})}),(0,t.jsx)(r.td,{children:"\u8ddf\u968f\u8005\u68c0\u6d4b\u9886\u5bfc\u8005\u5931\u6548\u7684\u8d85\u65f6\u65f6\u95f4"}),(0,t.jsx)(r.td,{children:"1s"}),(0,t.jsx)(r.td,{children:"1s-5s\uff0c\u901a\u5e38\u4e3a\u5fc3\u8df3\u95f4\u9694\u76842-4\u500d"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"MaxLogEntries"})}),(0,t.jsx)(r.td,{children:"\u5355\u6b21\u540c\u6b65\u6700\u5927\u65e5\u5fd7\u6761\u76ee\u6570"}),(0,t.jsx)(r.td,{children:"1000"}),(0,t.jsx)(r.td,{children:"500-5000\uff0c\u6839\u636e\u6761\u76ee\u5927\u5c0f\u8c03\u6574"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"SnapshotThreshold"})}),(0,t.jsx)(r.td,{children:"\u89e6\u53d1\u5feb\u7167\u7684\u65e5\u5fd7\u6761\u76ee\u9608\u503c"}),(0,t.jsx)(r.td,{children:"10000"}),(0,t.jsx)(r.td,{children:"5000-50000\uff0c\u6839\u636e\u5185\u5b58\u9650\u5236\u8c03\u6574"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"MaxRetries"})}),(0,t.jsx)(r.td,{children:"\u64cd\u4f5c\u6700\u5927\u91cd\u8bd5\u6b21\u6570"}),(0,t.jsx)(r.td,{children:"3"}),(0,t.jsx)(r.td,{children:"2-5\uff0c\u6839\u636e\u7f51\u7edc\u7a33\u5b9a\u6027\u8c03\u6574"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"RetryInterval"})}),(0,t.jsx)(r.td,{children:"\u91cd\u8bd5\u95f4\u9694"}),(0,t.jsx)(r.td,{children:"200ms"}),(0,t.jsx)(r.td,{children:"100ms-1s"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:(0,t.jsx)(r.code,{children:"ReplicationTimeout"})}),(0,t.jsx)(r.td,{children:"\u590d\u5236\u64cd\u4f5c\u8d85\u65f6"}),(0,t.jsx)(r.td,{children:"5s"}),(0,t.jsx)(r.td,{children:"2s-10s\uff0c\u6839\u636e\u6570\u636e\u91cf\u548c\u7f51\u7edc\u8c03\u6574"})]})]})]}),"\n",(0,t.jsx)(r.h2,{id:"\u5b9e\u9645\u5e94\u7528\u793a\u4f8b",children:"\u5b9e\u9645\u5e94\u7528\u793a\u4f8b"}),"\n",(0,t.jsx)(r.h3,{id:"\u57fa\u672c\u4e3b\u4ece\u590d\u5236\u8bbe\u7f6e",children:"\u57fa\u672c\u4e3b\u4ece\u590d\u5236\u8bbe\u7f6e"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n    "context"\r\n    "log"\r\n    "time"\r\n    \r\n    "github.com/fyerfyer/fyer-cache/cache"\r\n    "github.com/fyerfyer/fyer-cache/cache/replication"\r\n)\r\n\r\nfunc main() {\r\n    // \u521b\u5efa\u7f13\u5b58\u5b9e\u4f8b\r\n    leaderCache := cache.NewMemoryCache()\r\n    followerCache := cache.NewMemoryCache()\r\n    \r\n    // \u521b\u5efa\u590d\u5236\u65e5\u5fd7\r\n    leaderLog := replication.NewMemoryReplicationLog()\r\n    followerLog := replication.NewMemoryReplicationLog()\r\n    \r\n    // \u521b\u5efa\u6570\u636e\u540c\u6b65\u5668\r\n    leaderSyncer := replication.NewMemorySyncer("leader-1", leaderCache, leaderLog,\r\n        replication.WithAddress("localhost:8080"))\r\n    followerSyncer := replication.NewMemorySyncer("follower-1", followerCache, followerLog,\r\n        replication.WithAddress("localhost:8081"))\r\n    \r\n    // \u542f\u52a8\u540c\u6b65\u5668\r\n    leaderSyncer.Start()\r\n    followerSyncer.Start()\r\n    \r\n    // \u521b\u5efa\u9886\u5bfc\u8005\u8282\u70b9\r\n    leader := replication.NewLeaderNode("leader-1", leaderCache, leaderLog, leaderSyncer,\r\n        replication.WithHeartbeatInterval(500 * time.Millisecond))\r\n    \r\n    // \u521b\u5efa\u8ddf\u968f\u8005\u8282\u70b9\r\n    follower := replication.NewFollowerNode("follower-1", followerCache, followerLog, followerSyncer,\r\n        replication.WithElectionTimeout(2 * time.Second))\r\n    \r\n    // \u542f\u52a8\u8282\u70b9\r\n    leader.Start()\r\n    follower.Start()\r\n    \r\n    // \u914d\u7f6e\u8ddf\u968f\u8005\u6307\u5411\u9886\u5bfc\u8005\r\n    follower.SetLeader("leader-1", "localhost:8080")\r\n    \r\n    // \u6dfb\u52a0\u8ddf\u968f\u8005\u5230\u9886\u5bfc\u8005\r\n    leader.AddFollower("follower-1", "localhost:8081")\r\n    \r\n    // \u5728\u9886\u5bfc\u8005\u4e0a\u5199\u5165\u6570\u636e\r\n    ctx := context.Background()\r\n    leaderCache.Set(ctx, "user:1001", "John Doe", 10*time.Minute)\r\n    \r\n    // \u7b49\u5f85\u590d\u5236\u5b8c\u6210\r\n    time.Sleep(1 * time.Second)\r\n    \r\n    // \u4ece\u8ddf\u968f\u8005\u8bfb\u53d6\u6570\u636e\r\n    value, err := followerCache.Get(ctx, "user:1001")\r\n    if err != nil {\r\n        log.Printf("Error: %v", err)\r\n    } else {\r\n        log.Printf("Value from follower: %v", value)\r\n    }\r\n    \r\n    // \u6e05\u7406\u8d44\u6e90\r\n    leader.Stop()\r\n    follower.Stop()\r\n    leaderSyncer.Stop()\r\n    followerSyncer.Stop()\r\n}\n'})}),"\n",(0,t.jsx)(r.h3,{id:"\u96c6\u6210\u4e3b\u4ece\u590d\u5236\u548c\u96c6\u7fa4\u7ba1\u7406",children:"\u96c6\u6210\u4e3b\u4ece\u590d\u5236\u548c\u96c6\u7fa4\u7ba1\u7406"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'package main\r\n\r\nimport (\r\n    "context"\r\n    "log"\r\n    "time"\r\n    \r\n    "github.com/fyerfyer/fyer-cache/cache"\r\n    "github.com/fyerfyer/fyer-cache/cache/cluster"\r\n    "github.com/fyerfyer/fyer-cache/cache/cluster/integration"\r\n)\r\n\r\nfunc main() {\r\n    // \u521b\u5efa\u672c\u5730\u7f13\u5b58\r\n    cache1 := cache.NewMemoryCache()\r\n    cache2 := cache.NewMemoryCache()\r\n    cache3 := cache.NewMemoryCache()\r\n    \r\n    // \u521b\u5efa\u4e3b\u4ece\u96c6\u7fa4\u8282\u70b9\r\n    node1, err := integration.NewLeaderFollowerCluster(\r\n        "node-1", \r\n        "localhost:7946", \r\n        cache1,\r\n        []cluster.NodeOption{\r\n            cluster.WithGossipInterval(500 * time.Millisecond),\r\n        },\r\n        []integration.LeaderFollowerClusterOption{\r\n            integration.WithSyncerAddress("localhost:8080"),\r\n            integration.WithInitialRole(replication.RoleLeader),\r\n        },\r\n    )\r\n    if err != nil {\r\n        log.Fatalf("Failed to create node1: %v", err)\r\n    }\r\n    \r\n    node2, err := integration.NewLeaderFollowerCluster(\r\n        "node-2", \r\n        "localhost:7947", \r\n        cache2,\r\n        []cluster.NodeOption{\r\n            cluster.WithGossipInterval(500 * time.Millisecond),\r\n        },\r\n        []integration.LeaderFollowerClusterOption{\r\n            integration.WithSyncerAddress("localhost:8081"),\r\n        },\r\n    )\r\n    if err != nil {\r\n        log.Fatalf("Failed to create node2: %v", err)\r\n    }\r\n    \r\n    node3, err := integration.NewLeaderFollowerCluster(\r\n        "node-3", \r\n        "localhost:7948", \r\n        cache3,\r\n        []cluster.NodeOption{\r\n            cluster.WithGossipInterval(500 * time.Millisecond),\r\n        },\r\n        []integration.LeaderFollowerClusterOption{\r\n            integration.WithSyncerAddress("localhost:8082"),\r\n        },\r\n    )\r\n    if err != nil {\r\n        log.Fatalf("Failed to create node3: %v", err)\r\n    }\r\n    \r\n    // \u542f\u52a8\u6240\u6709\u8282\u70b9\r\n    node1.Start()\r\n    node2.Start()\r\n    node3.Start()\r\n    \r\n    // \u786e\u4fdd\u6b63\u786e\u6e05\u7406\r\n    defer func() {\r\n        node1.Stop()\r\n        node2.Stop()\r\n        node3.Stop()\r\n    }()\r\n    \r\n    // \u5f62\u6210\u96c6\u7fa4\r\n    node1.Join("localhost:7946")  // \u7b2c\u4e00\u4e2a\u8282\u70b9\u81ea\u5f15\u5bfc\r\n    time.Sleep(500 * time.Millisecond)\r\n    \r\n    node2.Join("localhost:7946")  // \u5176\u4ed6\u8282\u70b9\u52a0\u5165\u7b2c\u4e00\u4e2a\u8282\u70b9\r\n    time.Sleep(500 * time.Millisecond)\r\n    \r\n    node3.Join("localhost:7946")\r\n    \r\n    // \u7b49\u5f85\u96c6\u7fa4\u7a33\u5b9a\r\n    time.Sleep(2 * time.Second)\r\n    \r\n    // \u5199\u5165\u6570\u636e\u5230\u9886\u5bfc\u8005\r\n    ctx := context.Background()\r\n    node1.Set(ctx, "key1", "value1", 10*time.Minute)\r\n    \r\n    // \u7b49\u5f85\u590d\u5236\u5b8c\u6210\r\n    time.Sleep(1 * time.Second)\r\n    \r\n    // \u4ece\u8ddf\u968f\u8005\u8282\u70b9\u8bfb\u53d6\u6570\u636e\r\n    value, err := node2.Get(ctx, "key1")\r\n    if err != nil {\r\n        log.Printf("Error reading from node2: %v", err)\r\n    } else {\r\n        log.Printf("Value from node2: %v", value)\r\n    }\r\n}\n'})})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(s,{...e})}):s(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>o,x:()=>c});var l=n(6540);const t={},i=l.createContext(t);function o(e){const r=l.useContext(i);return l.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),l.createElement(i.Provider,{value:r},e.children)}}}]);